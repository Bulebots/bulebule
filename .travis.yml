language: python

python:
    - 3.6

addons:
  apt:
    sources:
      - llvm-toolchain-trusty-4.0
      - sourceline: 'ppa:team-gcc-arm-embedded/ppa'
    packages:
      - clang-format-4.0
      - gcc-arm-embedded

install:
  - pip install -r requirements.txt

before_script:
  - linux="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git"
  - wget $linux/plain/scripts/spelling.txt
  - wget $linux/plain/scripts/checkpatch.pl
  - wget $linux/plain/scripts/const_structs.checkpatch
  - chmod +x checkpatch.pl
  - clang-format() { clang-format-4.0 $@; }
  - export -f clang-format
  - export CHECKPATCH_OPTIONS="--terse --no-tree --max-line-length=80 --ignore ARRAY_SIZE --ignore VOLATILE"
  - ./scripts/setup_libopencm3.sh

script:
  - ./scripts/check_format.sh
  - ./checkpatch.pl $CHECKPATCH_OPTIONS --file src/*
  - cd src/ && make
  - cd ../ && pytest -sv

after_script:
  - rm checkpatch.pl
